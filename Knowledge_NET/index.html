<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Philosophical Connections</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    :root {
      --bg:        #0d0e14;
      --surface:   #13141c;
      --surface2:  #1a1b26;
      --border:    #2a2b38;
      --text:      #e8e2d6;
      --muted:     #7a7890;
      --amber:     #d4a853;
      --amber-dim: #8a6c35;

      --c-contradicts: #e05252;
      --c-converges:   #52b788;
      --c-extends:     #9b72cf;
      --c-mirrors:     #4e9ebc;
      --c-undermines:  #e89444;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Lora', Georgia, serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* ─── LAYOUT ─────────────────────────────────────────────────────── */

    #app { display: flex; flex-direction: column; height: 100vh; }

    header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 2.5rem;
      padding: 0 2rem;
      height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      z-index: 10;
    }

    .site-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 400;
      letter-spacing: 0.08em;
      color: var(--amber);
      white-space: nowrap;
    }

    .stats-bar {
      display: flex;
      gap: 1.5rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--muted);
    }
    .stats-bar span b { color: var(--text); font-weight: 400; }

    nav.tabs {
      display: flex;
      gap: 0;
      margin-left: auto;
    }

    .tab-btn {
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0 1.4rem;
      height: 52px;
      border: none;
      background: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
    }

    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--amber); border-bottom-color: var(--amber); }

    /* ─── TABS ───────────────────────────────────────────────────────── */

    .tab-panel { display: none; flex: 1; overflow: hidden; }
    .tab-panel.active { display: flex; }

    /* ─── GRAPH TAB ──────────────────────────────────────────────────── */

    #tab-graph { position: relative; }

    #graph-svg { width: 100%; height: 100%; cursor: grab; }
    #graph-svg:active { cursor: grabbing; }

    .graph-controls {
      position: absolute;
      top: 1.2rem;
      left: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 5;
    }

    .ctrl-panel {
      background: rgba(19, 20, 28, 0.92);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.9rem 1rem;
      backdrop-filter: blur(8px);
      min-width: 200px;
    }

    .ctrl-label {
      font-family: 'DM Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.6rem;
      display: block;
    }

    .edge-toggles { display: flex; flex-direction: column; gap: 0.4rem; }

    .edge-toggle {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem;
      color: var(--text);
      cursor: pointer;
      padding: 0.2rem 0;
      user-select: none;
    }

    .toggle-swatch {
      width: 18px; height: 3px;
      border-radius: 2px;
      transition: opacity 0.15s;
    }

    .edge-toggle.off .toggle-swatch { opacity: 0.2; }
    .edge-toggle.off { color: var(--muted); }

    .edge-count {
      margin-left: auto;
      font-size: 0.62rem;
      color: var(--muted);
    }

    .ctrl-select {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem;
      padding: 0.45rem 0.6rem;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }
    .ctrl-select:focus { border-color: var(--amber-dim); }

    .weight-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    input[type="range"] {
      flex: 1;
      accent-color: var(--amber);
      cursor: pointer;
    }

    .weight-val {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--amber);
      width: 1rem;
      text-align: right;
    }

    .ctrl-btn {
      font-family: 'DM Mono', monospace;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: border-color 0.15s, color 0.15s;
    }
    .ctrl-btn:hover { border-color: var(--amber-dim); color: var(--amber); }

    /* ─── NODE DETAIL PANEL ──────────────────────────────────────────── */

    #detail-panel {
      position: absolute;
      right: 0; top: 0; bottom: 0;
      width: 360px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.28s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 6;
      overflow: hidden;
    }

    #detail-panel.open { transform: translateX(0); }

    .detail-header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .detail-meta {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .detail-author {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--text);
    }

    .detail-source {
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .detail-id {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      color: var(--muted);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.3rem;
      line-height: 1;
      padding: 0.2rem;
      transition: color 0.15s;
    }
    .close-btn:hover { color: var(--text); }

    .detail-body { flex: 1; overflow-y: auto; padding: 1.25rem; }

    .detail-text {
      font-family: 'Lora', serif;
      font-size: 0.95rem;
      line-height: 1.65;
      color: var(--text);
      font-style: italic;
      margin-bottom: 1.25rem;
    }

    .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-bottom: 1.25rem;
    }

    .dtag {
      font-family: 'DM Mono', monospace;
      font-size: 0.62rem;
      padding: 0.2rem 0.55rem;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .dtag.domain { border-color: #2a4a7a; color: #6a9fd8; }
    .dtag.emotion { border-color: #5a2a4a; color: #c87ab0; }
    .dtag.stage { border-color: #1a4a35; color: #52b788; }
    .dtag.epistemic { border-color: var(--amber-dim); color: var(--amber); }

    .detail-notes {
      font-family: 'Lora', serif;
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.55;
      font-style: italic;
      padding: 0.75rem;
      background: var(--surface2);
      border-radius: 4px;
      margin-bottom: 1.25rem;
    }

    .connections-heading {
      font-family: 'DM Mono', monospace;
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    .conn-list { display: flex; flex-direction: column; gap: 0.4rem; }

    .conn-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.55rem 0.7rem;
      background: var(--surface2);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.12s;
      border: 1px solid transparent;
    }
    .conn-item:hover { background: #1e1f2e; border-color: var(--border); }

    .conn-type-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 5px;
    }

    .conn-text {
      font-family: 'Lora', serif;
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.4;
      flex: 1;
    }

    .conn-text strong {
      display: block;
      font-family: 'DM Mono', monospace;
      font-size: 0.62rem;
      color: var(--muted);
      font-weight: 400;
      margin-bottom: 0.15rem;
    }

    .conn-label {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      color: var(--muted);
      margin-top: 0.15rem;
      font-style: italic;
    }

    /* ─── GRAPH LEGEND (bottom right) ────────────────────────────────── */

    #author-legend {
      position: absolute;
      bottom: 1.2rem;
      right: 1.2rem;
      background: rgba(19, 20, 28, 0.88);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.8rem 1rem;
      backdrop-filter: blur(6px);
      max-height: 300px;
      overflow-y: auto;
      z-index: 5;
      display: none;
    }

    #author-legend.visible { display: block; }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      color: var(--muted);
      cursor: pointer;
    }

    .legend-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-toggle-btn {
      position: absolute;
      bottom: 1.2rem;
      right: 1.2rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: rgba(19,20,28,0.88);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 0.4rem 0.7rem;
      border-radius: 4px;
      cursor: pointer;
      z-index: 4;
      backdrop-filter: blur(6px);
    }

    /* D3 graph elements */
    .node circle { cursor: pointer; transition: r 0.15s; }
    .node circle:hover { filter: brightness(1.3); }
    .node.dimmed circle { opacity: 0.12; }
    .node.dimmed text { opacity: 0; }
    .node text {
      font-family: 'DM Mono', monospace;
      font-size: 7px;
      fill: var(--muted);
      pointer-events: none;
      text-anchor: middle;
    }

    .link { stroke-opacity: 0.55; transition: stroke-opacity 0.15s; }
    .link.dimmed { stroke-opacity: 0.04; }
    .link.highlighted { stroke-opacity: 0.9; stroke-width: 2px; }

    /* ─── BROWSE TAB ─────────────────────────────────────────────────── */

    #tab-browse {
      flex-direction: column;
      overflow: hidden;
    }

    .browse-controls {
      flex-shrink: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 1rem 2rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      min-width: 140px;
      flex: 1;
    }

    .filter-group:first-child { flex: 2; min-width: 240px; }

    .filter-group label {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .filter-group input,
    .filter-group select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      padding: 0.45rem 0.65rem;
      border-radius: 4px;
      outline: none;
      width: 100%;
    }

    .filter-group input:focus,
    .filter-group select:focus { border-color: var(--amber-dim); }

    option { background: var(--surface2); }

    .browse-main {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 2rem;
    }

    .results-count {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 1.25rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 1.25rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.4rem;
      display: flex;
      flex-direction: column;
      gap: 0;
      transition: border-color 0.2s;
    }

    .card:hover { border-color: var(--amber-dim); }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.85rem;
    }

    .card-author {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.05rem;
      font-weight: 400;
      color: var(--text);
    }

    .card-source {
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .card-node-id {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      color: #444;
      margin-bottom: 0.5rem;
    }

    .card-text {
      font-family: 'Lora', serif;
      font-size: 0.92rem;
      line-height: 1.65;
      color: var(--text);
      margin-bottom: 1.1rem;
      flex: 1;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.9rem;
    }

    .btag {
      font-family: 'DM Mono', monospace;
      font-size: 0.6rem;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .btag.domain { border-color: #2a4a7a; color: #6a9fd8; }
    .btag.emotion { border-color: #5a2a4a; color: #c87ab0; }
    .btag.stage { border-color: #1a4a35; color: #52b788; }
    .btag.epistemic { border-color: var(--amber-dim); color: var(--amber); }

    .card-notes {
      font-family: 'Lora', serif;
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
      line-height: 1.5;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    /* ─── LOADING STATE ──────────────────────────────────────────────── */

    #loading {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: var(--bg);
      z-index: 100;
      gap: 1rem;
    }

    .loading-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      color: var(--amber);
      letter-spacing: 0.08em;
    }

    .loading-sub {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .loading-error {
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      color: var(--c-contradicts);
      text-align: center;
      max-width: 400px;
      line-height: 1.6;
    }

    /* scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  </style>
</head>
<body>

<div id="loading">
  <div class="loading-title">Philosophical Connections</div>
  <div class="loading-sub">Loading graph data...</div>
</div>

<div id="app" style="display:none;">
  <header>
    <span class="site-title">Philosophical Connections</span>
    <div class="stats-bar">
      <span id="stat-nodes"><b>—</b> nodes</span>
      <span id="stat-edges"><b>—</b> edges</span>
      <span id="stat-authors"><b>—</b> thinkers</span>
    </div>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="graph">Graph</button>
      <button class="tab-btn" data-tab="browse">Browse</button>
    </nav>
  </header>

  <!-- ── GRAPH TAB ─────────────────────────────────────────────── -->
  <div class="tab-panel active" id="tab-graph">
    <svg id="graph-svg"></svg>

    <div class="graph-controls">
      <!-- Edge type toggles -->
      <div class="ctrl-panel">
        <span class="ctrl-label">Edge types</span>
        <div class="edge-toggles" id="edge-toggles"></div>
      </div>

      <!-- Author filter -->
      <div class="ctrl-panel">
        <span class="ctrl-label">Highlight author</span>
        <select class="ctrl-select" id="graph-author-filter">
          <option value="">All authors</option>
        </select>
      </div>

      <!-- Weight filter -->
      <div class="ctrl-panel">
        <span class="ctrl-label">Min edge weight</span>
        <div class="weight-row">
          <input type="range" id="weight-slider" min="1" max="3" step="1" value="1">
          <span class="weight-val" id="weight-display">1</span>
        </div>
      </div>

      <button class="ctrl-btn" id="reset-btn">↺ Reset view</button>
    </div>

    <!-- Author legend (bottom right) -->
    <button class="legend-toggle-btn" id="legend-toggle">Authors</button>
    <div id="author-legend"></div>

    <!-- Node detail panel -->
    <div id="detail-panel">
      <div class="detail-header">
        <div class="detail-meta">
          <span class="detail-author" id="dp-author">—</span>
          <span class="detail-source" id="dp-source">—</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;">
          <button class="close-btn" id="detail-close">×</button>
          <span class="detail-id" id="dp-id">—</span>
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-text" id="dp-text"></div>
        <div class="detail-tags" id="dp-tags"></div>
        <div class="detail-notes" id="dp-notes" style="display:none;"></div>
        <div class="connections-heading">Connections</div>
        <div class="conn-list" id="dp-connections"></div>
      </div>
    </div>
  </div>

  <!-- ── BROWSE TAB ────────────────────────────────────────────── -->
  <div class="tab-panel" id="tab-browse">
    <div class="browse-controls">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" id="b-search" placeholder="Search text, author, concept...">
      </div>
      <div class="filter-group">
        <label>Author</label>
        <select id="b-author"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Domain</label>
        <select id="b-domain"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Emotional register</label>
        <select id="b-emotion"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Life stage</label>
        <select id="b-stage"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Epistemic status</label>
        <select id="b-epistemic"><option value="">All</option></select>
      </div>
    </div>
    <div class="browse-main">
      <div class="results-count" id="b-count"></div>
      <div class="cards-grid" id="b-grid"></div>
    </div>
  </div>
</div>

<script>
// ── Data & State ─────────────────────────────────────────────────────────

const AUTHOR_COLORS = {
  'Adam Smith':        '#C4956A',
  'Albert Camus':      '#5B9BD5',
  'Aristotle':         '#D4AF37',
  'Atul Gawande':      '#7BAFBC',
  'Bill Bryson':       '#78C7A8',
  'Blaise Pascal':     '#C285A0',
  'Boethius':          '#7B9E5E',
  'Charles Darwin':    '#8DB87A',
  'Ernest Becker':     '#D4813A',
  'Friedrich Nietzsche': '#7B85D4',
  'Fyodor Dostoevsky': '#C75757',
  'Henry Thoreau':     '#5B9B6B',
  'Laozi':             '#6BBFB8',
  'Marcus Aurelius':   '#D4C15A',
  'Michel de Montaigne': '#B89060',
  'Simone Weil':       '#9B7EC8',
  'Soren Kierkegaard': '#4E7BC4',
  'Viktor Frankl':     '#6BA5D4',
  'Vyasa (trad.)':     '#E8A53A',
};

const EDGE_COLORS = {
  contradicts: '#e05252',
  converges:   '#52b788',
  extends:     '#9b72cf',
  mirrors:     '#4e9ebc',
  undermines:  '#e89444',
};

let allNodes = [], allEdges = [];
let activeEdgeTypes = new Set(['contradicts','converges','extends','mirrors','undermines']);
let minWeight = 1;
let graphAuthorFilter = '';
let selectedNodeId = null;
let simulation, svgEl, linkGroup, nodeGroup, zoomBehavior;

// ── Boot ─────────────────────────────────────────────────────────────────

Promise.all([
  fetch('./data/nodes.json').then(r => r.json()),
  fetch('./data/edges.json').then(r => r.json()),
]).then(([nodes, edges]) => {
  allNodes = nodes;
  allEdges = edges;
  bootstrap();
}).catch(() => {
  document.querySelector('#loading .loading-sub').innerHTML = `
    <div class="loading-error">
      Could not load data files.<br>
      Ensure <code>data/nodes.json</code> and <code>data/edges.json</code>
      are in the same directory as <code>index.html</code>.<br><br>
      If testing locally, run a local server:<br>
      <code>python3 -m http.server</code>
    </div>`;
});

function bootstrap() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'flex';

  // Stats bar
  document.querySelector('#stat-nodes b').textContent = allNodes.length;
  document.querySelector('#stat-edges b').textContent = allEdges.length;
  document.querySelector('#stat-authors b').textContent = Object.keys(AUTHOR_COLORS).length;

  setupTabs();
  setupGraph();
  setupBrowse();
}

// ── Tabs ─────────────────────────────────────────────────────────────────

function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'graph' && simulation) {
        // Re-center on tab switch
        setTimeout(resetView, 50);
      }
    });
  });
}

// ── Graph ─────────────────────────────────────────────────────────────────

function setupGraph() {
  buildEdgeToggles();
  buildAuthorFilter();
  buildAuthorLegend();

  document.getElementById('weight-slider').addEventListener('input', e => {
    minWeight = +e.target.value;
    document.getElementById('weight-display').textContent = minWeight;
    updateGraph();
  });

  document.getElementById('graph-author-filter').addEventListener('change', e => {
    graphAuthorFilter = e.target.value;
    applyHighlight();
  });

  document.getElementById('reset-btn').addEventListener('click', resetView);
  document.getElementById('detail-close').addEventListener('click', closeDetail);

  document.getElementById('legend-toggle').addEventListener('click', () => {
    const leg = document.getElementById('author-legend');
    const btn = document.getElementById('legend-toggle');
    const vis = leg.classList.toggle('visible');
    btn.textContent = vis ? '× Close' : 'Authors';
    btn.style.display = vis ? 'none' : 'block';
  });

  initD3Graph();
}

function buildEdgeToggles() {
  const container = document.getElementById('edge-toggles');
  const counts = {};
  allEdges.forEach(e => { counts[e.type] = (counts[e.type] || 0) + 1; });

  const types = ['contradicts','converges','extends','mirrors','undermines'];
  types.forEach(type => {
    const div = document.createElement('div');
    div.className = 'edge-toggle';
    div.dataset.type = type;
    div.innerHTML = `
      <span class="toggle-swatch" style="background:${EDGE_COLORS[type]}"></span>
      <span>${type}</span>
      <span class="edge-count">${counts[type] || 0}</span>`;
    div.addEventListener('click', () => {
      if (activeEdgeTypes.has(type)) activeEdgeTypes.delete(type);
      else activeEdgeTypes.add(type);
      div.classList.toggle('off', !activeEdgeTypes.has(type));
      updateGraph();
    });
    container.appendChild(div);
  });
}

function buildAuthorFilter() {
  const sel = document.getElementById('graph-author-filter');
  const authors = Object.keys(AUTHOR_COLORS).sort();
  authors.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a; opt.textContent = a;
    sel.appendChild(opt);
  });
}

function buildAuthorLegend() {
  const container = document.getElementById('author-legend');
  const span = document.createElement('span');
  span.className = 'ctrl-label';
  span.style.display = 'block';
  span.style.marginBottom = '0.6rem';
  span.textContent = 'Authors';
  container.appendChild(span);

  Object.entries(AUTHOR_COLORS).sort((a,b) => a[0].localeCompare(b[0])).forEach(([author, color]) => {
    const row = document.createElement('div');
    row.className = 'legend-row';
    row.innerHTML = `<span class="legend-dot" style="background:${color}"></span>${author}`;
    row.addEventListener('click', () => {
      const sel = document.getElementById('graph-author-filter');
      sel.value = sel.value === author ? '' : author;
      graphAuthorFilter = sel.value;
      applyHighlight();
    });
    container.appendChild(row);
  });

  const closeRow = document.createElement('button');
  closeRow.style.cssText = 'margin-top:0.6rem;width:100%;background:none;border:none;color:var(--muted);font-family:"DM Mono",monospace;font-size:0.62rem;cursor:pointer;text-align:center;';
  closeRow.textContent = '× close';
  closeRow.addEventListener('click', () => {
    document.getElementById('author-legend').classList.remove('visible');
    document.getElementById('legend-toggle').style.display = 'block';
  });
  container.appendChild(closeRow);
}

function initD3Graph() {
  svgEl = d3.select('#graph-svg');
  const rect = document.getElementById('tab-graph').getBoundingClientRect();
  const W = rect.width || window.innerWidth;
  const H = rect.height || window.innerHeight - 52;

  const container = svgEl.append('g').attr('id', 'zoom-container');
  linkGroup = container.append('g').attr('id', 'links');
  nodeGroup = container.append('g').attr('id', 'nodes');

  zoomBehavior = d3.zoom()
    .scaleExtent([0.08, 4])
    .on('zoom', e => container.attr('transform', e.transform));
  svgEl.call(zoomBehavior);

  // Build node map
  const nodeById = {};
  allNodes.forEach(n => {
    n._degree = 0;
    nodeById[n.id] = n;
  });
  allEdges.forEach(e => {
    if (nodeById[e.source]) nodeById[e.source]._degree++;
    if (nodeById[e.target]) nodeById[e.target]._degree++;
  });

  // Init simulation with all nodes (we filter edges dynamically)
  simulation = d3.forceSimulation(allNodes)
    .force('charge', d3.forceManyBody().strength(d => -120 - d._degree * 8))
    .force('center', d3.forceCenter(W / 2, H / 2).strength(0.08))
    .force('collision', d3.forceCollide().radius(d => nodeRadius(d) + 3))
    .alphaDecay(0.025)
    .velocityDecay(0.4);

  simulation.on('tick', ticked);

  updateGraph();

  function ticked() {
    linkGroup.selectAll('.link')
      .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    nodeGroup.selectAll('.node')
      .attr('transform', d => `translate(${d.x},${d.y})`);
  }
}

function nodeRadius(d) {
  return 3.5 + Math.sqrt(d._degree || 0) * 1.4;
}

function updateGraph() {
  if (!simulation) return;

  const visibleEdges = allEdges.filter(e =>
    activeEdgeTypes.has(e.type) && e.weight >= minWeight
  );

  // Build lookup of node ids that have connections
  const connectedIds = new Set();
  visibleEdges.forEach(e => {
    connectedIds.add(typeof e.source === 'object' ? e.source.id : e.source);
    connectedIds.add(typeof e.target === 'object' ? e.target.id : e.target);
  });

  // Links
  const links = linkGroup.selectAll('.link').data(visibleEdges, d => d.id);
  links.exit().remove();
  links.enter().append('line')
    .attr('class', 'link')
    .attr('stroke', d => EDGE_COLORS[d.type])
    .attr('stroke-width', d => d.weight === 3 ? 1.8 : d.weight === 2 ? 1.2 : 0.7)
    .merge(links);

  // Nodes
  const nodeData = allNodes;
  const nodes = nodeGroup.selectAll('.node').data(nodeData, d => d.id);

  const entered = nodes.enter().append('g').attr('class', 'node')
    .call(d3.drag()
      .on('start', dragStart)
      .on('drag', dragging)
      .on('end', dragEnd));

  entered.append('circle')
    .attr('r', 0)
    .attr('fill', d => AUTHOR_COLORS[d.author] || '#888')
    .attr('stroke', d => AUTHOR_COLORS[d.author] || '#888')
    .attr('stroke-width', 0.8)
    .attr('stroke-opacity', 0.4)
    .transition().duration(600)
    .attr('r', d => nodeRadius(d));

  entered.append('text')
    .attr('dy', d => nodeRadius(d) + 8)
    .text(d => d._degree >= 8 ? d.author.split(' ').pop() : '');

  const allNodeSel = entered.merge(nodes);

  allNodeSel.select('circle')
    .attr('fill', d => AUTHOR_COLORS[d.author] || '#888')
    .attr('r', d => nodeRadius(d));

  allNodeSel.on('click', (event, d) => {
    event.stopPropagation();
    selectNode(d);
  });

  nodes.exit().remove();

  // Update link force
  simulation.force('link',
    d3.forceLink(visibleEdges)
      .id(d => d.id)
      .distance(d => 60 + (3 - d.weight) * 35)
      .strength(d => 0.12 + d.weight * 0.06)
  );
  simulation.alpha(0.4).restart();

  applyHighlight();
}

function applyHighlight() {
  const allNodeSel = nodeGroup.selectAll('.node');
  const allLinkSel = linkGroup.selectAll('.link');

  if (!graphAuthorFilter && !selectedNodeId) {
    allNodeSel.classed('dimmed', false);
    allLinkSel.classed('dimmed', false).classed('highlighted', false);
    return;
  }

  if (graphAuthorFilter && !selectedNodeId) {
    allNodeSel.classed('dimmed', d => d.author !== graphAuthorFilter);
    allLinkSel.classed('dimmed', true).classed('highlighted', false);
    return;
  }

  if (selectedNodeId) {
    const visibleEdges = allEdges.filter(e =>
      activeEdgeTypes.has(e.type) && e.weight >= minWeight
    );
    const connIds = new Set();
    connIds.add(selectedNodeId);
    visibleEdges.forEach(e => {
      const s = typeof e.source === 'object' ? e.source.id : e.source;
      const t = typeof e.target === 'object' ? e.target.id : e.target;
      if (s === selectedNodeId) connIds.add(t);
      if (t === selectedNodeId) connIds.add(s);
    });

    allNodeSel.classed('dimmed', d => !connIds.has(d.id));
    allLinkSel.classed('highlighted', d => {
      const s = typeof d.source === 'object' ? d.source.id : d.source;
      const t = typeof d.target === 'object' ? d.target.id : d.target;
      return s === selectedNodeId || t === selectedNodeId;
    }).classed('dimmed', d => {
      const s = typeof d.source === 'object' ? d.source.id : d.source;
      const t = typeof d.target === 'object' ? d.target.id : d.target;
      return s !== selectedNodeId && t !== selectedNodeId;
    });
  }
}

function selectNode(d) {
  selectedNodeId = d.id;
  applyHighlight();
  openDetail(d);
}

function openDetail(d) {
  const panel = document.getElementById('detail-panel');
  panel.classList.add('open');

  document.getElementById('dp-author').textContent = d.author;
  document.getElementById('dp-source').textContent = d.source;
  document.getElementById('dp-id').textContent = d.id;
  document.getElementById('dp-text').textContent = d.text;

  // Tags
  const tagsEl = document.getElementById('dp-tags');
  tagsEl.innerHTML = '';
  if (d.epistemic_status) {
    tagsEl.innerHTML += `<span class="dtag epistemic">${d.epistemic_status.replace(/_/g,' ')}</span>`;
  }
  (d.domains || []).forEach(t => tagsEl.innerHTML += `<span class="dtag domain">${t}</span>`);
  (d.emotional_registers || []).forEach(t => tagsEl.innerHTML += `<span class="dtag emotion">${t}</span>`);
  (d.life_stages || []).forEach(t => tagsEl.innerHTML += `<span class="dtag stage">${t}</span>`);

  // Notes
  const notesEl = document.getElementById('dp-notes');
  if (d.notes) {
    notesEl.textContent = d.notes;
    notesEl.style.display = 'block';
  } else {
    notesEl.style.display = 'none';
  }

  // Connections
  const connEl = document.getElementById('dp-connections');
  connEl.innerHTML = '';

  const nodeById = {};
  allNodes.forEach(n => nodeById[n.id] = n);

  const connected = allEdges.filter(e => {
    const s = typeof e.source === 'object' ? e.source.id : e.source;
    const t = typeof e.target === 'object' ? e.target.id : e.target;
    return s === d.id || t === d.id;
  });

  // Sort: weight desc, then by type
  connected.sort((a, b) => b.weight - a.weight || a.type.localeCompare(b.type));

  connected.forEach(edge => {
    const s = typeof edge.source === 'object' ? edge.source.id : edge.source;
    const t = typeof edge.target === 'object' ? edge.target.id : edge.target;
    const otherId = s === d.id ? t : s;
    const other = nodeById[otherId];
    if (!other) return;

    const item = document.createElement('div');
    item.className = 'conn-item';
    item.innerHTML = `
      <span class="conn-type-dot" style="background:${EDGE_COLORS[edge.type]};"></span>
      <div class="conn-text">
        <strong>${other.id} · ${edge.type} (w${edge.weight})</strong>
        ${other.text.slice(0,100)}...
        <div class="conn-label">${edge.label}</div>
      </div>`;
    item.addEventListener('click', () => {
      const targetNode = allNodes.find(n => n.id === otherId);
      if (targetNode) selectNode(targetNode);
    });
    connEl.appendChild(item);
  });

  if (connected.length === 0) {
    connEl.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:0.7rem;color:var(--muted);">No connections visible under current filters.</div>';
  }
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('open');
  selectedNodeId = null;
  applyHighlight();
}

svgEl && svgEl.on('click', closeDetail);

function resetView() {
  if (!svgEl || !zoomBehavior) return;
  const rect = document.getElementById('tab-graph').getBoundingClientRect();
  svgEl.transition().duration(600).call(
    zoomBehavior.transform,
    d3.zoomIdentity.translate(rect.width / 2, rect.height / 2).scale(0.7).translate(-rect.width / 2, -rect.height / 2)
  );
}

function dragStart(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}

function dragging(event, d) {
  d.fx = event.x; d.fy = event.y;
}

function dragEnd(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null; d.fy = null;
}

// ── Browse ────────────────────────────────────────────────────────────────

function setupBrowse() {
  const authors  = [...new Set(allNodes.map(n => n.author))].sort();
  const domains  = [...new Set(allNodes.flatMap(n => n.domains || []))].sort();
  const emotions = [...new Set(allNodes.flatMap(n => n.emotional_registers || []))].sort();
  const stages   = [...new Set(allNodes.flatMap(n => n.life_stages || []))].sort();
  const epists   = [...new Set(allNodes.map(n => n.epistemic_status).filter(Boolean))].sort();

  populateSelect('b-author', authors);
  populateSelect('b-domain', domains);
  populateSelect('b-emotion', emotions);
  populateSelect('b-stage', stages);
  populateSelect('b-epistemic', epists);

  ['b-search','b-author','b-domain','b-emotion','b-stage','b-epistemic'].forEach(id => {
    document.getElementById(id).addEventListener('input', renderBrowse);
    document.getElementById(id).addEventListener('change', renderBrowse);
  });

  renderBrowse();
}

function populateSelect(id, options) {
  const sel = document.getElementById(id);
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o; opt.textContent = o;
    sel.appendChild(opt);
  });
}

function renderBrowse() {
  const search   = document.getElementById('b-search').value.toLowerCase();
  const author   = document.getElementById('b-author').value;
  const domain   = document.getElementById('b-domain').value;
  const emotion  = document.getElementById('b-emotion').value;
  const stage    = document.getElementById('b-stage').value;
  const epistemic = document.getElementById('b-epistemic').value;

  const filtered = allNodes.filter(n => {
    if (search && !n.text.toLowerCase().includes(search) &&
        !n.author.toLowerCase().includes(search) &&
        !(n.notes || '').toLowerCase().includes(search)) return false;
    if (author && n.author !== author) return false;
    if (domain && !(n.domains || []).includes(domain)) return false;
    if (emotion && !(n.emotional_registers || []).includes(emotion)) return false;
    if (stage && !(n.life_stages || []).includes(stage)) return false;
    if (epistemic && n.epistemic_status !== epistemic) return false;
    return true;
  });

  document.getElementById('b-count').textContent =
    `${filtered.length} of ${allNodes.length} nodes`;

  const authorColor = (author) => AUTHOR_COLORS[author] || '#888';

  document.getElementById('b-grid').innerHTML = filtered.map(n => {
    const domTags = (n.domains || []).map(d => `<span class="btag domain">${d}</span>`).join('');
    const emTags  = (n.emotional_registers || []).map(e => `<span class="btag emotion">${e}</span>`).join('');
    const stTags  = (n.life_stages || []).map(s => `<span class="btag stage">${s}</span>`).join('');
    const epTag   = n.epistemic_status
      ? `<span class="btag epistemic">${n.epistemic_status.replace(/_/g,' ')}</span>` : '';

    const color = authorColor(n.author);

    return `<div class="card" style="border-left: 3px solid ${color}22; border-top: none;">
      <div class="card-node-id">${n.id}</div>
      <div class="card-top">
        <span class="card-author" style="color:${color}">${n.author}</span>
        <span class="card-source">${n.source}</span>
      </div>
      <div class="card-text">${n.text}</div>
      <div class="card-tags">${epTag}${domTags}${emTags}${stTags}</div>
      ${n.notes ? `<div class="card-notes">${n.notes}</div>` : ''}
    </div>`;
  }).join('');
}

// Click outside detail panel closes it
document.addEventListener('click', e => {
  const panel = document.getElementById('detail-panel');
  if (panel && panel.classList.contains('open') && !panel.contains(e.target)) {
    // only close if click is on the svg
    if (e.target.closest('#graph-svg') && !e.target.closest('.node')) {
      closeDetail();
    }
  }
});
</script>
</body>
</html>
